<!DOCTYPE html>
<html>
<head>

  <meta charset="UTF-8" />
  <title>https://www.neoncrm.com/</title>
  <style>
    body, html {
      font-family: monospace;
      color: #333;
      box-sizing: border-box;
    }
    * {
      font-family: inherit;
      color: inherit;
      box-sizing: inherit;
    }
    .links a {
      display: none;
    }
    .tree {

    }
    .tree a {
      
    }
    .tree a:hover {
      
    }
    .img-holder {
      position: fixed;
      top: 20px;
      right: 20px;
    }
    .img-holder {
      width: 500px;
      white-space: nowrap;
      background: #ffffff;
      z-index: 1;
      padding: 5px;
      border: 3px solid black;
      overflow: scroll;
      line-height: 1.5;
    }
    .img-holder p a {
      padding-bottom: 5px;
    }
    .img-holder img {
      display: block;
      border: 3px solid #333;
      width: 100%;
      /*margin: 10px 0;*/
      border-left: 0;
      border-right: 0;
      width: calc(100% + 10px);
      margin-left: -5px;

    }

    .sub_parent {
      display: none;
    }
    .toggle {
      cursor: pointer;
    }
    .root {
      font-weight: bold;
    }
    .children {
      padding-left: 2em;
      display: none;
    }
    p {
      margin: 0;
    }
    button {
      appearance: none;
      background: transparent;
      border: none;
      padding:0;
      margin:0;
    }
  </style>
  <script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js" integrity="sha256-VeNaFBVDhoX3H+gJ37DpT/nTuZTdjYro9yBruHjVmoQ=" crossorigin="anonymous"></script>
</head>
<body>

<div class="img-holder" style="display:none"></div>
<strong>All Neon One Properties</strong>
<div class="loading"><em>loading...</em></div>
<div class="appender tree">

</div>

<script>

  var angle = '└&nbsp;';
  var arr = '↗';
  var toggle = '<button class="toggle">+</button>&nbsp;';

  var depth_obj = {children:{}};

  var sitemap_json = [];

  function pretty_path_split(path) {
    if(path != '/') {

        
      if(path.indexOf('/') == 0) {
        path = path.slice(1,path.length);
      }
      if(path.length && path[path.length -1] == '/') {
        path = path.slice(0,path.length-1);
      }
      // console.log(path);
      return path.split('/');
    } else {
      return ['/'];
    }
    
  }

  var createLinks = function() {
    for(var i=0;i<sitemap_json.length;i++){
      var url = sitemap_json[i];
      // console.log(url);
      //first find out the host
      var host = url.url.split('://')[1];

      var hostPathArr = host.split('/');
      
      host = hostPathArr[0];
      // console.log(host);
      

      //now get a path string, with leading/trailing slashes

      var path = '/';
      if(url.url.split(host)[1]) {
        path = url.url.split(host)[1];
        
        if(path.indexOf('/') == 0) {
          path = path.slice(1,path.length);
        }
        if(path.length && path[path.length -1] == '/') {
          path = path.slice(0,path.length-1);
        }
      }

      
      
      var path_split = path.split('/');
      var fullpath_formatted = path=='/'?'/':'/'+path+'/';

      url.fullpath_formatted = fullpath_formatted;
      url.host = host;
      url.path_split = path_split;

      if(!depth_obj.children[host]) {
        depth_obj.children[host] = {urls:['/'],children:{},path:'/',level:0};
      }

      if(path_split.length >= 1 || path.length != 0) {
        var parent = depth_obj.children[host];
        _.each(path_split,function(path_part,i){
          var level = i + 1;
          var path_part_formatted = path_part+'/';
          if(path_part_formatted != '/'){
            if(!parent.children[path_part_formatted]){
              parent.children[path_part_formatted] = {urls:[],path:path_part_formatted,children:{},level:level};
            }
            
            if(path_split.length == level) {
              depth_obj.children[host].urls.push(fullpath_formatted);
            }
            parent = parent.children[path_part_formatted];
          }
        });
      }

     

    }

    console.log(depth_obj);

    //create the html

    //loop through all children, get total counts, needs to go inifinite deep
    var $appender = $('.appender');
    _.each(depth_obj.children,function(v,k){ //some kind of serious recurision problem here is killing chrome, they are all nested at all levels?
      //create a top level holder
      var host = k;
      // console.log(host);
      var $host_parent = $(document.createElement('div'));
      $host_parent.addClass('parent');
      $host_parent.attr('data-count',1);
      $host_parent.attr('data-host',host);
      $host_parent.append('<p>'+toggle+'<button class="url">'+host+'/</button><a href="https://'+host+'" target="_blank">'+arr+'</a></p>');
      $host_parent.append($(document.createElement('div')).addClass('children'));
     
      var host_count = 1;
      var path_count = 0;

      $appender.append($host_parent);

      _.each(v.urls, function(url){
        if(url!='/') {
          host_count++;
          var levels_to_make = pretty_path_split(url);
          var $this_parent;
          _.each(levels_to_make, function(level, idx){
            path_count++;
            var path_id = host+'|'+level+'|'+idx;
            var parent_identified = false;

            var last_level = idx==levels_to_make.length-1;
            if(idx == 0) {
              $this_parent = $host_parent; //always start back at the host/parent, which has to exist
              parent_found = true;
            } else {
              // console.log(level, idx);
              var parent_idx = idx-1;
              var parent_path_id =  host+'|'+levels_to_make[parent_idx] +'|'+parent_idx;
              $this_parent = $($this_parent.find('.children')[0]).find('[data-path-id="'+parent_path_id+'"]');

            }
            //now we have a path, and a path parent identified.
            //if there is no parent (how could that be??) i dont think that can happen, but in case lets do an if check
            if(parent_found || $this_parent.length) {
              $this_parent = $($this_parent[0]);//turn it back into a jquery object
              //does this path already exist?
              var $self = $($this_parent.find('.children')[0]).find('[data-path-id="'+path_id+'"]');
              
              if($self.length) {
                $self = $($self[0]);//turn it bakc into a jquery object

                var $a = $self.children().first().find('a');
                var $btn = $self.children().first().find('button.toggle');
                //do i need to do anything at all? 
                //if it is the last one, might need to add a href and either way increase the counter?
                $self.attr('data-count',parseInt($self.attr('data-count'))+1);
                
                // console.log($a.length,$btn.length, last_level);

                if(last_level){
                  if(!$a.length){
                    // console.log('ERROR: node existed but there was no link');
                    $self.children().first().html('<p>'+toggle+'<button class="url">'+level+'</button><a target="_blank"  tabindex="-1" data-rel-path="'+host+url+'" href="https://'+host+url+'">'+arr+'</a></p>');
                  }
                } else {
                  if(!$btn.length){
                    // console.log('ERROR: node existed but no button');
                    $self.children().first().prepend(toggle);
                  }
                }
               
                
              } else {
                //no existing child node at this path level on the current parent, need to create it
                $self = $(document.createElement('div'));
                $self.addClass('self');
                $self.attr('data-count',0);
                $self.attr('data-path-id',path_id);
                if(last_level) {
                  $self.attr('data-count',1);
                  $self.append('<p><button class="url">'+level+'</button><a target="_blank" tabindex="-1" data-rel-path="'+host+url+'" href="https://'+host+url+'">'+arr+'</a></p>');
                } else {
                  $self.append('<p>'+toggle+level+'</p>');
                }
                
                $self.attr('data-host',k);
                $self.append($(document.createElement('div')).addClass('children'));
                $($this_parent.find('.children')[0]).append($self);
              }
            } else {
              console.log('ERROR: no parent div found');
            }
            
          });
        }
        
      });


      console.log('parent', host, 'had', host_count, path_count);

      
    });


    $('.loading').remove();
    //sort links alphabetically
    $('.children').each(function(){
      var $list = $(this);
      var items = $(this).children('div');
      items.sort(function(a, b) {
        // console.log('sorting?')
        // console.log($(a).find('div:first-of-type').text(),$(b).find('div:first-of-type'));
        return $($(a).find('p')[0]).text().toUpperCase().localeCompare($($(b).find('p')[0]).text().toUpperCase());
      });
      $.each(items, function(idx, itm) { $list.append(itm); });
    });

    //count links at each level
    $('.parent').each(function(){
      var count =$(this).find('a').length;
      $(this).children().first().append('<span class="count">('+count+')</span>');
    });
    $('.self').each(function(){
      var count = $(this).find('a').length;
      if(count > 1) {
        $(this).children().first().append('<span class="count">('+count+')</span>');
      }
      
    });

    //hook up any listeners
    $('.toggle').click(function(){
      if($(this).text() == '+') {
        $(this).text('-');
        $(this).parent().next().show();
      } else {
        $(this).text('+');
        $(this).parent().next().hide();
      }
      
    });

    $('button.url').focus(function(){
      populateUrlInfo($(this).parent());
    });

  }

  
  $.get('./sitemap_all.json')
    .done(function(data){
      console.log('got json');
      sitemap_json = data;
      createLinks();
    })
    .fail(function(err) {
      console.log('error');
    });


  //get some counts, maybe re-order by cound
  // depth_obj.count = depth_obj.urls.length;
  // _.forEach(depth_obj.children, function(level) {
  //   level.count = level.urls.length;
  //   _.forEach(level.children, function(sub_level){
  //     sub_level.count = sub_level.urls.length;
  //   });

  // });
  // console.log(depth_obj);
  // $('.total').text(depth_obj.urls.length);
  // var $appender = $('.appender');
  // var root = $('.level_0').attr('href');
  // $('.level_0')
  // _.forEach(depth_obj.children, function(level) {
  //   // console.log(level);
  //   var $parent = $(document.createElement('div'));
  //   $parent.attr('data-count',level.count);
  //   $parent.addClass('parent');
  //   var spaces = '';
  //   var count = level.count>1?'('+level.count+')':'';
  //   for(var i=0;i<level.level;i++){
  //     spaces+='&nbsp;'
  //   }

  //   var has_children = _.keys(level.children).length;
  //   var toggler = angle;
  //   if(has_children) {
  //     toggler = toggle;
  //   }

  //   if(_.includes(level.urls,'/'+level.path)) { //if the path matches any children, this is a linkable top
  //     $parent.append('<div>'+spaces+toggler+'<button class="info">'+level.path+'</button>&nbsp;<a href="'+root+level.path+'" target="_blank" class="level_'+level.level+'" tabindex="-1">'+arr+'</a> '+count+'</div>');
  //   } else { //still create the top but not as a link
  //     $parent.append('<div class="level_'+level.level+'">'+spaces+toggler+level.path+' '+count+'</div>');
  //   }
  //   if(_.keys(level.children).length) { //has children, this only works due to being 2 levels deep max //
  //     _.forEach(level.children, function(sub_level){
  //       var $sub_parent = $(document.createElement('div'));
  //       $sub_parent.attr('data-count',sub_level.count);
  //       $sub_parent.addClass('sub_parent');
  //       var spaces = '';
  //       var count = sub_level.count>1?'('+sub_level.count+')':'';
  //       for(var i=0;i<sub_level.level;i++){
  //         spaces+='&nbsp;'
  //       }
  //       if(_.includes(sub_level.urls,'/'+level.path+sub_level.path)) { //if the path matches any urls, this is a linkable sub
  //         $sub_parent.append('<div>'+spaces+angle+'<button class="info">'+sub_level.path+'</button>&nbsp;<a href="'+root+level.path+sub_level.path+'" target="_blank" class="level_'+sub_level.level+'" tabindex="-1">'+arr+'</a> '+count+'</div>');
  //       } else { //still create the top but not as a link
  //         $sub_parent.append('<div class="level'+sub_level.level+'">'+spaces+angle+sub_level.path+' '+count+'</div>');
  //       }
  //       $parent.append($sub_parent);
  //     });
  //   }
  //   $appender.append($parent);
  // });



  // var $list = $('.appender');
  // console.log($list);
  

  // var $wrapper = $('.appender');
  // $wrapper.find('.parent').sort(function(a, b) {
  //   return +b.dataset.count - +a.dataset.count;
  // })
  // .appendTo($wrapper);

  // $('.parent').each(function(){
  //   var $list = $(this);
  //   var items = $(this).children('.sub_parent').get();
  //   items.sort(function(a, b) {
  //     return $(a).text().toUpperCase().localeCompare($(b).text().toUpperCase());
  //   });
  //   $.each(items, function(idx, itm) { $list.append(itm); });
  // });

  function populateUrlInfo($el) {
    $('.img-holder').show();
    if($el.find('a').attr('href')) {

      var $img = $(document.createElement('div'));
      $img.addClass('img-preview');
      var href = $el.find('a').attr('href');

      var file_path = href.replace('https://','./')+'/';
      file_path = file_path.replace('//','/');

      console.log(href, file_path);

      $img.append('<p><strong><a target="_blank" href="'+href+'">'+href+'</a></strong></p>');

      $.get(file_path+'stats.json')
        .done(function(data){
          var src = file_path+'lighhouse_desktop.jpg';
          $img.append('<a href="'+href+'" target="_blank"><img src="'+src+'"></a>');

          var $data = $(document.createElement('div'));
          if(data.title) {
            $data.append('<p>title: '+data.title+'</p>');
          }
          if(data.lighthouse.desktop) {
            $data.append('<p>crawled: '+new Date(data.time)+'</p>');
            $data.append('<p>speed: '+data.lighthouse.desktop.page_speed+'</p>');
            $data.append('<p>a11y: '+data.lighthouse.desktop.a11y+'</p>');
            $data.append('<p>seo: '+data.lighthouse.desktop.seo+'</p>');
            $data.append('<p>bp: '+data.lighthouse.desktop.best_practices+'</p>');
          }

          $img.append($data);
          $('.img-holder').html($img.html());
        })
        .fail(function(err) {
          console.log('failed');
          $img.append('<p><em>in progress</em></p>');
          $('.img-holder').html($img);
          console.log('error');
        });

      
    }
  }
  // $('button.info').click(function(){
  //   populateUrlInfo($(this).parent());
  // })


  

  
</script>
</body>
</html>
